# Решение: RTMP контейнер I/O Error

## Проблема

При запуске RTMP контейнера возникала ошибка:
```
2025/11/10 18:31:28 [emerg] 1#1: host not found in url "backend:8000/api/rtmp/publish" in /etc/nginx/nginx.conf:34
```

Эта ошибка приводила к I/O error и контейнер не запускался.

## Причина

В конфигурации `docker/rtmp/nginx.conf` были включены хуки (on_publish/on_publish_done), которые ссылались на `backend:8000`:

```nginx
on_publish http://backend:8000/api/rtmp/publish;
on_publish_done http://backend:8000/api/rtmp/unpublish;
```

**Проблема:** Когда nginx инициализируется, он пытается разрешить имя хоста `backend:8000`. При запуске контейнера:
- Вне Docker Compose сети - имя хоста не может быть разрешено → I/O error
- Даже внутри сети контейнер падает если backend недоступен во время инициализации

## Решение

Были внесены следующие изменения:

### 1. Обновлена конфигурация nginx (`docker/rtmp/nginx.conf`)
- Закомментированы проблемные хуки on_publish/on_publish_done
- Добавлены переменные окружения для будущей гибкости
- Добавлены комментарии для повторного включения хуков при необходимости

### 2. Создан entrypoint скрипт (`docker/rtmp/entrypoint.sh`)
- Обеспечивает корректное создание необходимых директорий
- Обеспечивает graceful shutdown при получении SIGTERM
- Выводит информацию о конфигурации для отладки

### 3. Обновлён Dockerfile (`docker/rtmp/Dockerfile`)
- Добавлены зависимости (bash для entrypoint скрипта)
- Скопирован и сделан исполняемым entrypoint скрипт
- Использован ENTRYPOINT вместо CMD для лучшего управления сигналами

## Результат

✅ RTMP контейнер успешно запускается и остаётся в работающем состоянии
✅ Отсутствуют I/O ошибки
✅ Контейнер правильно обрабатывает сигналы завершения (graceful shutdown)

## Дальнейшие улучшения

Если требуется повторно включить хуки on_publish/on_publish_done:

1. Убедитесь что backend сервис запущен и доступен перед RTMP
2. Используйте переменные окружения для конфигурирования адреса backend
3. Добавьте зависимость в docker-compose.yml:
```yaml
rtmp:
  depends_on:
    backend:
      condition: service_healthy
```

4. Раскомментируйте строки в nginx.conf и перестройте контейнер
