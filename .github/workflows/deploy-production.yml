name: Deploy to Production

on:
  push:
    branches:
      - stable
  workflow_dispatch:

jobs:
  deploy-production:
    name: Deploy to Production (Stable)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/stable' && github.event_name == 'push'
    permissions:
      packages: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: |
          VERSION=$(git describe --tags --always --abbrev=7)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Build and push backend image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/xatube-backend:${{ steps.version.outputs.VERSION }}
            ${{ secrets.DOCKERHUB_USERNAME }}/xatube-backend:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/xatube-backend:production
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: frontend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/xatube-frontend:${{ steps.version.outputs.VERSION }}
            ${{ secrets.DOCKERHUB_USERNAME }}/xatube-frontend:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/xatube-frontend:production
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create deployment release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: deploy-${{ steps.version.outputs.VERSION }}-$(date +%s)
          release_name: Production Deployment - ${{ steps.version.outputs.VERSION }}
          body: |
            ## Production Deployment
            
            **Version:** ${{ steps.version.outputs.VERSION }}
            **Branch:** stable
            **Date:** $(date -u)
            
            ### Docker Images
            - Backend: `${{ secrets.DOCKERHUB_USERNAME }}/xatube-backend:${{ steps.version.outputs.VERSION }}`
            - Frontend: `${{ secrets.DOCKERHUB_USERNAME }}/xatube-frontend:${{ steps.version.outputs.VERSION }}`
            
            ### Changes
            Commit: ${{ github.sha }}
            
            To deploy, use:
            ```bash
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/xatube-backend:${{ steps.version.outputs.VERSION }}
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/xatube-frontend:${{ steps.version.outputs.VERSION }}
            
            docker-compose -f docker-compose.yml up -d
            ```
          draft: false
          prerelease: false

      - name: Send deployment notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üöÄ Production Deployment - ${{ steps.version.outputs.VERSION }}"
          to: ltpddwk@gmail.com
          from: ${{ secrets.MAIL_FROM }}
          body: |
            <html>
              <body style="font-family: Arial, sans-serif; color: #333;">
                <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                  <h2 style="color: #27ae60;">üöÄ Production Deployment Successful</h2>
                  
                  <div style="background: #d4edda; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #28a745;">
                    <p><strong>Version deployed:</strong> <code>${{ steps.version.outputs.VERSION }}</code></p>
                  </div>
                  
                  <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0;">
                    <p><strong>Deployment Details:</strong></p>
                    <ul style="list-style: none; padding: 0;">
                      <li>üì¶ <strong>Backend Image:</strong><br><code>${{ secrets.DOCKERHUB_USERNAME }}/xatube-backend:${{ steps.version.outputs.VERSION }}</code></li>
                      <li>üì¶ <strong>Frontend Image:</strong><br><code>${{ secrets.DOCKERHUB_USERNAME }}/xatube-frontend:${{ steps.version.outputs.VERSION }}</code></li>
                      <li>üîó <strong>Pipeline:</strong> <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">View on GitHub</a></li>
                      <li>üìù <strong>Commit:</strong> <code>${{ github.sha }}</code></li>
                    </ul>
                  </div>
                  
                  <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #ffc107;">
                    <p><strong>Next steps:</strong></p>
                    <ol>
                      <li>Pull latest images from Docker Hub</li>
                      <li>Update your docker-compose.yml with the new version tags</li>
                      <li>Run: <code>docker-compose up -d</code></li>
                    </ol>
                  </div>
                  
                  <hr style="border: none; border-top: 1px solid #ddd; margin: 30px 0;">
                  <p style="color: #7f8c8d; font-size: 12px;">
                    Repository: <a href="https://github.com/${{ github.repository }}">${{ github.repository }}</a>
                  </p>
                </div>
              </body>
            </html>
          content_type: text/html
