name: Email Notification - Test Results

on:
  workflow_run:
    workflows: [CI - Tests & Build]
    types: [completed]

jobs:
  send-email:
    name: Send Test Results Email
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download workflow artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
            console.log('Artifacts:', artifacts);

      - name: Prepare email content
        id: email_content
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          COMMIT="${{ github.event.workflow_run.head_commit }}"
          AUTHOR="${{ github.event.workflow_run.actor }}"
          STATUS="${{ github.event.workflow_run.conclusion }}"
          RUN_ID="${{ github.event.workflow_run.id }}"
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —ç–º–æ–¥–∑–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É
          if [ "$STATUS" = "success" ]; then
            EMOJI="‚úÖ"
            STATUS_TEXT="–£–°–ü–ï–®–ù–û"
            STATUS_LONG="–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
          elif [ "$STATUS" = "failure" ]; then
            EMOJI="‚ùå"
            STATUS_TEXT="–û–®–ò–ë–ö–ê"
            STATUS_LONG="–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏!"
          else
            EMOJI="‚ö†Ô∏è"
            STATUS_TEXT="$STATUS"
            STATUS_LONG="–°—Ç–∞—Ç—É—Å: $STATUS"
          fi
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∏—Å—å–º–∞
          EMAIL_BODY=$(cat << EOF
          <html>
            <body style="font-family: Arial, sans-serif; color: #333;">
              <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                <h2 style="color: #2c3e50;">$EMOJI CI/CD Pipeline - $STATUS_TEXT</h2>
                
                <p><strong>$STATUS_LONG</strong></p>
                
                <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0;">
                  <p><strong>–î–µ—Ç–∞–ª–∏ –∑–∞–ø—É—Å–∫–∞:</strong></p>
                  <ul style="list-style: none; padding: 0;">
                    <li>üìå <strong>–í–µ—Ç–∫–∞:</strong> <code>$BRANCH</code></li>
                    <li>üë§ <strong>–ê–≤—Ç–æ—Ä:</strong> $AUTHOR</li>
                    <li>üíæ <strong>–ö–æ–º–º–∏—Ç:</strong> <code>${COMMIT:0:7}</code></li>
                    <li>üîó <strong>Pipeline:</strong> <a href="https://github.com/${{ github.repository }}/actions/runs/$RUN_ID">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ GitHub</a></li>
                  </ul>
                </div>
                
                <div style="background: #e8f4f8; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #3498db;">
                  <h3 style="color: #2c3e50; margin-top: 0;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:</h3>
                  <ul style="list-style: none; padding: 0;">
                    <li><strong>‚úì Backend Lint:</strong> –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞</li>
                    <li><strong>‚úì Backend Tests:</strong> Unit —Ç–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º</li>
                    <li><strong>‚úì Frontend Lint:</strong> ESLint & Prettier</li>
                    <li><strong>‚úì Frontend Tests:</strong> Unit —Ç–µ—Å—Ç—ã & Build</li>
                    <li><strong>‚úì Docker Build:</strong> –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤</li>
                  </ul>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #ffc107;">
                  <p><strong>‚ö° –°–æ–≤–µ—Ç:</strong> –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–µ—Ç–∞–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ GitHub Actions –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ—Å—Ç–∞—Ö.</p>
                </div>
                
                <hr style="border: none; border-top: 1px solid #ddd; margin: 30px 0;">
                <p style="color: #7f8c8d; font-size: 12px;">
                  –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–∏—Å—å–º–æ –æ—Ç CI/CD —Å–∏—Å—Ç–µ–º—ã xatube.<br>
                  –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: <a href="https://github.com/${{ github.repository }}">${{ github.repository }}</a>
                </p>
              </div>
            </body>
          </html>
          EOF
          )
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ
          echo "EMAIL_BODY<<EOF" >> $GITHUB_OUTPUT
          echo "$EMAIL_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "STATUS_TEXT=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "EMOJI=$EMOJI" >> $GITHUB_OUTPUT

      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "${{ steps.email_content.outputs.EMOJI }} [${{ github.event.workflow_run.head_branch }}] CI/CD - ${{ steps.email_content.outputs.STATUS_TEXT }}"
          to: ltpddwk@gmail.com
          from: ${{ secrets.MAIL_FROM }}
          body: ${{ steps.email_content.outputs.EMAIL_BODY }}
          content_type: text/html
          cc: ""
          bcc: ""
