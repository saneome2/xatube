user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        timeout 60s;

        # Main application
        application live {
            live on;
            
            # Recording settings
            record off;
            record_path /recordings;
            record_append on;

            # HLS output
            hls on;
            hls_path /tmp/hls;
            hls_fragment 3;
            hls_playlist_length 20;
            
            # DASH output
            dash on;
            dash_path /tmp/dash;
            dash_fragment 3;
            dash_playlist_length 20;

            # Allow publish from any IP (restrict in production)
            allow publish all;
            allow play all;

            # On publish hooks for stream management
            on_publish http://backend:8000/api/rtmp/publish;
            on_publish_done http://backend:8000/api/rtmp/unpublish;

            # Fallback application
            application_created on;
        }

        # Statistics page
        application stat {
            live on;
        }
    }
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    access_log /var/log/nginx/access.log;

    sendfile on;

    # RTMP stat page
    server {
        listen 8080;

        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }

        location /stat.xsl {
            root /usr/local/nginx/html;
        }

        # HLS delivery
        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /tmp;
            add_header Cache-Control "no-cache";
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS';
        }

        # DASH delivery
        location /dash {
            types {
                application/dash+xml mpd;
                video/mp4 m4s;
                video/mp4 mp4;
            }
            root /tmp;
            add_header Cache-Control "no-cache";
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS';
        }

        # Health check
        location /health {
            access_log off;
            return 200 "RTMP server is healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
