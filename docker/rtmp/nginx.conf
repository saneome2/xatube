user www-data;
worker_processes auto;
pid /var/run/nginx.pid;
error_log /var/log/nginx/error.log debug;

# Переменные окружения для хуков (можно переопределить при запуске)
env BACKEND_HOST;
env BACKEND_PORT;

events {
    worker_connections 1024;
}

# Для HTTP запросов (on_publish использует HTTP POST)
http {
    # Динамическое разрешение имён хостов
    resolver 127.0.0.11 valid=10s;
    resolver_timeout 5s;
}

rtmp_auto_push on;
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        timeout 60s;
        listen [::]:1935 ipv6only=on;
        # Main application
        application live {
            live on;
            record off;
            record_path /recordings;
            record_append on;

            # HLS output (включается только при успешной валидации ключа через on_publish)
            hls on;
            hls_path /tmp/hls;
            hls_fragment 3;
            hls_playlist_length 20;

            # DASH output
            dash on;
            dash_path /tmp/dash;
            dash_fragment 3;
            dash_playlist_length 20;

            # On publish hooks for stream management
            on_publish http://$BACKEND_HOST:$BACKEND_PORT/api/rtmp/publish;
            on_publish_done http://$BACKEND_HOST:$BACKEND_PORT/api/rtmp/unpublish;

            # Allow publish from any IP (restrict in production)
            allow publish all;
            allow play all;
        }

        # Statistics page
        application stat {
            live on;
        }
    }
}